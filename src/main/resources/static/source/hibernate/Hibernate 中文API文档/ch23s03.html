<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=GBK">
<title>23.3.&#160;Customer(客户)/Order(订单)/Product(产品)</title>
<link rel="stylesheet" href="styles/html.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.71.0">
<link rel="start" href="index.html" title="HIBERNATE - 符合Java习惯的关系数据库持久化">
<link rel="up" href="ch23.html" title="第&#160;23&#160;章&#160;示例：复杂映射实例">
<link rel="prev" href="ch23s02.html" title="23.2.&#160;Author(作家)/Work(作品)">
<link rel="next" href="ch23s04.html" title="23.4.&#160;杂例">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="example-mappings-customerorderproduct"></a>23.3.&#160;Customer(客户)/Order(订单)/Product(产品)</h2></div></div></div>
<p>
            
            现在来考虑<code class="literal">Customer</code>,<code class="literal">Order</code> ， <code class="literal">LineItem</code>
            和 <code class="literal">Product</code>关系的模型。<code class="literal">Customer</code> 和 <code class="literal">Order</code>之间
            是一对多的关系，但是我们怎么来描述<code class="literal">Order</code> / <code class="literal">LineItem</code> / <code class="literal">Product</code>呢？
            我可以把<code class="literal">LineItem</code>作为描述<code class="literal">Order</code> 和 <code class="literal">Product</code>
            多对多关系的关联类，在Hibernate，这叫做组合元素。
        </p>
<div class="mediaobject" align="center"><img src="images/CustomerOrderProduct.gif" align="middle"></div>
<p>
            映射文件如下：
        </p>
<pre class="programlisting">&lt;hibernate-mapping&gt;

    &lt;class name="Customer" table="customers"&gt;
        &lt;id name="id"&gt;
            &lt;generator class="native"/&gt;
        &lt;/id&gt;
        &lt;property name="name"/&gt;
        &lt;set name="orders" inverse="true"&gt;
            &lt;key column="customer_id"/&gt;
            &lt;one-to-many class="Order"/&gt;
        &lt;/set&gt;
    &lt;/class&gt;

    &lt;class name="Order" table="orders"&gt;
        &lt;id name="id"&gt;
            &lt;generator class="native"/&gt;
        &lt;/id&gt;
        &lt;property name="date"/&gt;
        &lt;many-to-one name="customer" column="customer_id"/&gt;
        &lt;list name="lineItems" table="line_items"&gt;
            &lt;key column="order_id"/&gt;
            &lt;list-index column="line_number"/&gt;
            &lt;composite-element class="LineItem"&gt;
                &lt;property name="quantity"/&gt;
                &lt;many-to-one name="product" column="product_id"/&gt;
            &lt;/composite-element&gt;
        &lt;/list&gt;
    &lt;/class&gt;

    &lt;class name="Product" table="products"&gt;
        &lt;id name="id"&gt;
            &lt;generator class="native"/&gt;
        &lt;/id&gt;
        &lt;property name="serialNumber"/&gt;
    &lt;/class&gt;

&lt;/hibernate-mapping&gt;</pre>
<p>
        <code class="literal">customers</code>, <code class="literal">orders</code>, <code class="literal">line_items</code> 和 
        <code class="literal">products</code> 分别保存着customer, order, order line item 和 product的数据。
        <code class="literal">line_items</code>也作为连接orders 和 products的关联表。
    </p>
<pre class="programlisting">create table customers (
    id BIGINT not null generated by default as identity, 
    name VARCHAR(255), 
    primary key (id)
)

create table orders (
    id BIGINT not null generated by default as identity, 
    customer_id BIGINT, 
    date TIMESTAMP, 
    primary key (id)
)

create table line_items (
    line_number INTEGER not null, 
    order_id BIGINT not null, 
    product_id BIGINT, 
    quantity INTEGER, 
    primary key (order_id, line_number)
)

create table products (
    id BIGINT not null generated by default as identity, 
    serialNumber VARCHAR(255), 
    primary key (id)
)

alter table orders 
    add constraint ordersFK0 foreign key (customer_id) references customers
alter table line_items
    add constraint line_itemsFK0 foreign key (product_id) references products
alter table line_items
    add constraint line_itemsFK1 foreign key (order_id) references orders</pre>
</div></body>
</html>
