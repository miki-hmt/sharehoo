<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=GBK">
<title>第&#160;20&#160;章&#160;工具箱指南</title>
<link rel="stylesheet" href="styles/html.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.71.0">
<link rel="start" href="index.html" title="HIBERNATE - 符合Java习惯的关系数据库持久化">
<link rel="up" href="index.html" title="HIBERNATE - 符合Java习惯的关系数据库持久化">
<link rel="prev" href="ch19s06.html" title="19.6.&#160; 监测性能（Monitoring performance）">
<link rel="next" href="ch21.html" title="第&#160;21&#160;章&#160;示例：父子关系(Parent Child Relationships)">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="toolsetguide"></a>第&#160;20&#160;章&#160;工具箱指南</h2></div></div></div>
<div class="toc">
<p><b>目录</b></p>
<dl>
<dt><span class="sect1"><a href="ch20.html#toolsetguide-s1">20.1. Schema自动生成（Automatic schema generation）</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-2">20.1.1. 对schema定制化(Customizing the schema)</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-3">20.1.2. 运行该工具</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-4">20.1.3. 属性(Properties)</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-5">20.1.4. 使用Ant(Using Ant)</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-6">20.1.5. 对schema的增量更新(Incremental schema updates)</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-7">20.1.6. 用Ant来增量更新schema(Using Ant for incremental schema updates)</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-8">20.1.7. Schema 校验</a></span></dt>
<dt><span class="sect2"><a href="ch20.html#toolsetguide-s1-9">20.1.8. 使用Ant进行schema校验</a></span></dt>
</dl></dd>
</dl>
</div>
<p>
		可以通过一系列Eclipse插件、命令行工具和Ant任务来进行与Hibernate关联的转换。

    </p>
<p>
        除了Ant任务外，当前的<span class="emphasis"><em>Hibernate Tools</em></span>也包含了Eclipse IDE的插件，用于与现存数据库的逆向工程。
    </p>
<div class="itemizedlist"><ul type="disc">
<li><p>

            <span class="emphasis"><em>Mapping Editor:</em></span> Hibernate XML映射文件的编辑器，支持自动完成和语法高亮。它也支持对类名和属性/字段名的语义自动完成，比通常的XML编辑器方便得多。
        </p></li>
<li><p>
            <span class="emphasis"><em>Console:</em></span> Console是Eclipse的一个新视图。除了对你的console配置的树状概览，你还可以获得对你持久化类及其关联的交互式视图。Console允许你对数据库执行HQL查询，并直接在Eclipse中浏览结果。
        </p></li>
<li><p>
            <span class="emphasis"><em>Development Wizards:</em></span> 在Hibernate Eclipse tools中还提供了几个向导；你可以用向导快速生成Hibernate 配置文件（cfg.xml），你甚至还可以同现存的数据库schema中反向工程出POJO源代码与Hibernate 映射文件。反向工程支持可定制的模版。
        </p></li>
<li><p>
            <span class="emphasis"><em>Ant Tasks:</em></span>
        </p></li>
</ul></div>
<p>
        要得到更多信息，请查阅 <span class="emphasis"><em>Hibernate Tools</em></span> 包及其文档。
    </p>
<p>
        同时，Hibernate主发行包还附带了一个集成的工具（它甚至可以在Hibernate“内部”快速运行）<span class="emphasis"><em>SchemaExport</em></span> ，也就是        <code class="literal">hbm2ddl</code>。

    </p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="toolsetguide-s1"></a>20.1.&#160;Schema自动生成（Automatic schema generation）</h2></div></div></div>
<p>
            可以从你的映射文件使用一个Hibernate工具生成DDL。 生成的schema包含有对实体和集合类表的完整性引用约束（主键和外键）。涉及到的标示符生成器所需的表和sequence也会同时生成。
        </p>
<p>
            在使用这个工具的时候，你<span class="emphasis"><em>必须</em></span> 通过<code class="literal">hibernate.dialet</code>属性指定一个SQL<code class="literal">方言(Dialet)</code>，因为DDL是与供应商高度相关的。
        </p>
<p>
            首先，要定制你的映射文件，来改善生成的schema。
        </p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-2"></a>20.1.1.&#160;对schema定制化(Customizing the schema)</h3></div></div></div>
<p>
                很多Hibernate映射元素定义了可选的<code class="literal">length</code>、<code class="literal">precision</code> 或者 <code class="literal">scale</code>属性。你可以通过这个属性设置字段的长度、精度、小数点位数。 
            </p>
<pre class="programlisting">&lt;property name="zip" length="5"/&gt;</pre>
<pre class="programlisting">&lt;property name="balance" precision="12" scale="2"/&gt;</pre>
<p>
                有些tag还接受<code class="literal">not-null</code>属性（用来在表字段上生成<code class="literal">NOT NULL</code>约束）和<code class="literal">unique</code>属性（用来在表字段上生成<code class="literal">UNIQUE</code>约束）。
            </p>
<pre class="programlisting">&lt;many-to-one name="bar" column="barId" not-null="true"/&gt;</pre>
<pre class="programlisting">&lt;element column="serialNumber" type="long" not-null="true" unique="true"/&gt;</pre>
<p>
                <code class="literal">unique-key</code>属性可以对成组的字段指定一个唯一键约束(unique key constraint)。目前，<code class="literal">unique-key</code>属性指定的值在生成DDL时<span class="emphasis"><em>并不会</em></span>被当作这个约束的名字，它们只是在用来在映射文件内部用作区分的。
            </p>
<pre class="programlisting">&lt;many-to-one name="org" column="orgId" unique-key="OrgEmployeeId"/&gt;
&lt;property name="employeeId" unique-key="OrgEmployee"/&gt;</pre>
<p>
                <code class="literal">index</code>属性会用对应的字段（一个或多个）生成一个index,它指出了这个index的名字。如果多个字段对应的index名字相同，就会生成包含这些字段的index。
            </p>
<pre class="programlisting">&lt;property name="lastName" index="CustName"/&gt;
&lt;property name="firstName" index="CustName"/&gt;</pre>
<p>
                <code class="literal">foreign-key</code>属性可以用来覆盖任何生成的外键约束的名字。
            </p>
<pre class="programlisting">&lt;many-to-one name="bar" column="barId" foreign-key="FKFooBar"/&gt;</pre>
<p>
                很多映射元素还接受<code class="literal">&lt;column&gt;</code>子元素。这在定义跨越多字段的类型时特别有用。
            </p>
<pre class="programlisting">&lt;property name="name" type="my.customtypes.Name"/&gt;
    &lt;column name="last" not-null="true" index="bar_idx" length="30"/&gt;
    &lt;column name="first" not-null="true" index="bar_idx" length="20"/&gt;
    &lt;column name="initial"/&gt;
&lt;/property&gt;</pre>
<p>
                <code class="literal">default</code>属性为字段指定一个默认值 (在保存被映射的类的新实例之前，你应该将同样的值赋于对应的属性)。
            </p>
<pre class="programlisting">&lt;property name="credits" type="integer" insert="false"&gt;
    &lt;column name="credits" default="10"/&gt;
&lt;/property&gt;</pre>
<pre class="programlisting">&lt;version name="version" type="integer" insert="false"&gt;
    &lt;column name="version" default="0"/&gt;
&lt;/property&gt;</pre>
<p>
                <code class="literal">sql-type</code>属性允许用户覆盖默认的Hibernate类型到SQL数据类型的映射。
            </p>
<pre class="programlisting">&lt;property name="balance" type="float"&gt;
    &lt;column name="balance" sql-type="decimal(13,3)"/&gt;
&lt;/property&gt;</pre>
<p>
                <code class="literal">check</code>属性允许用户指定一个约束检查。
            </p>
<pre class="programlisting">&lt;property name="foo" type="integer"&gt;
    &lt;column name="foo" check="foo &gt; 10"/&gt;
&lt;/property&gt;</pre>
<pre class="programlisting">&lt;class name="Foo" table="foos" check="bar &lt; 100.0"&gt;
    ...
    &lt;property name="bar" type="float"/&gt;
&lt;/class&gt;</pre>
<div class="table">
<a name="schemattributes-summary"></a><p class="title"><b>表&#160;20.1.&#160;Summary</b></p>
<div class="table-contents"><table summary="Summary" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th>属性(Attribute)</th>
<th>值（Values）</th>
<th>解释（Interpretation）</th>
</tr></thead>
<tbody>
<tr>
<td><code class="literal">length</code></td>
<td>数字</td>
<td>字段长度</td>
</tr>
<tr>
<td><code class="literal">precision</code></td>
<td>数字</td>
<td>精度(decimal precision)</td>
</tr>
<tr>
<td><code class="literal">scale</code></td>
<td>数字</td>
<td>小数点位数(decimal scale)</td>
</tr>
<tr>
<td><code class="literal">not-null</code></td>
<td><code class="literal">true|false</code></td>
<td>指明字段是否应该是非空的</td>
</tr>
<tr>
<td><code class="literal">unique</code></td>
<td><code class="literal">true|false</code></td>
<td>指明是否该字段具有惟一约束</td>
</tr>
<tr>
<td><code class="literal">index</code></td>
<td><code class="literal">index_name</code></td>
<td>指明一个（多字段）的索引(index)的名字</td>
</tr>
<tr>
<td><code class="literal">unique-key</code></td>
<td><code class="literal">unique_key_name</code></td>
<td>指明多字段惟一约束的名字（参见上面的说明）</td>
</tr>
<tr>
<td><code class="literal">foreign-key</code></td>
<td><code class="literal">foreign_key_name</code></td>
<td>
                                                                specifies the name of the foreign key constraint generated
                                for an association, for a <code class="literal">&lt;one-to-one&gt;</code>, 
                                <code class="literal">&lt;many-to-one&gt;</code>, <code class="literal">&lt;key&gt;</code>, 
                                or <code class="literal">&lt;many-to-many&gt;</code> mapping element. Note that
                                <code class="literal">inverse="true"</code> sides will not be considered
                                by <code class="literal">SchemaExport</code>.
                                指明一个外键的名字，它是为关联生成的，或者<code class="literal">&lt;one-to-one&gt;</code>，<code class="literal">&lt;many-to-one&gt;</code>, <code class="literal">&lt;key&gt;</code>, 或者<code class="literal">&lt;many-to-many&gt;</code>映射元素。注意<code class="literal">inverse="true"</code>在<code class="literal">SchemaExport</code>时会被忽略。

                            </td>
</tr>
<tr>
<td><code class="literal">sql-type</code></td>
<td><code class="literal">SQL 字段类型</code></td>
<td>
                                覆盖默认的字段类型(只能用于<code class="literal">&lt;column&gt;</code>属性）
                            </td>
</tr>
<tr>
<td><code class="literal">default</code></td>
<td>SQL表达式</td>
<td>
                                为字段指定默认值
                            </td>
</tr>
<tr>
<td><code class="literal">check</code></td>
<td>SQL 表达式</td>
<td>
                            	对字段或表加入SQL约束检查
                            </td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break"><p>
                <code class="literal">&lt;comment&gt;</code>元素可以让你在生成的schema中加入注释。
            </p>
<pre class="programlisting">&lt;class name="Customer" table="CurCust"&gt;
    &lt;comment&gt;Current customers only&lt;/comment&gt;
    ...
&lt;/class&gt;</pre>
<pre class="programlisting">&lt;property name="balance"&gt;
    &lt;column name="bal"&gt;
        &lt;comment&gt;Balance in USD&lt;/comment&gt;
    &lt;/column&gt;
&lt;/property&gt;</pre>
<p>
                结果是在生成的DDL中包含<code class="literal">comment on table</code> 或者
                <code class="literal">comment on column</code>语句(假若支持的话)。
            </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-3"></a>20.1.2.&#160;运行该工具</h3></div></div></div>
<p>
                <code class="literal">SchemaExport</code>工具把DDL脚本写到标准输出，同时/或者执行DDL语句。
            </p>
<p>
                <code class="literal">java -cp </code><span class="emphasis"><em>hibernate_classpaths</em></span>
                <code class="literal">org.hibernate.tool.hbm2ddl.SchemaExport</code> <span class="emphasis"><em>options mapping_files</em></span>
            </p>
<div class="table">
<a name="id544648"></a><p class="title"><b>表&#160;20.2.&#160;<code class="literal">SchemaExport</code>命令行选项</b></p>
<div class="table-contents"><table summary="SchemaExport命令行选项" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th>选项</th>
<th>说明</th>
</tr></thead>
<tbody>
<tr>
<td><code class="literal">--quiet</code></td>
<td>不要把脚本输出到stdout</td>
</tr>
<tr>
<td><code class="literal">--drop</code></td>
<td>只进行drop tables的步骤</td>
</tr>
<tr>
<td><code class="literal">--create</code></td>
<td>只创建表</td>
</tr>
<tr>
<td><code class="literal">--text</code></td>
<td>不执行在数据库中运行的步骤</td>
</tr>
<tr>
<td><code class="literal">--output=my_schema.ddl</code></td>
<td>把输出的ddl脚本输出到一个文件</td>
</tr>
<tr>
<td><code class="literal">--naming=eg.MyNamingStrategy</code></td>
<td>选择一个命名策略(<code class="literal">NamingStrategy</code>)</td>
</tr>
<tr>
<td><code class="literal">--config=hibernate.cfg.xml</code></td>
<td>从XML文件读入Hibernate配置</td>
</tr>
<tr>
<td><code class="literal">--properties=hibernate.properties</code></td>
<td>从文件读入数据库属性</td>
</tr>
<tr>
<td><code class="literal">--format</code></td>
<td>把脚本中的SQL语句对齐和美化</td>
</tr>
<tr>
<td><code class="literal">--delimiter=;</code></td>
<td>为脚本设置行结束符</td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break"><p>
                你甚至可以在你的应用程序中嵌入<code class="literal">SchemaExport</code>工具:
            </p>
<pre class="programlisting">Configuration cfg = ....;
new SchemaExport(cfg).create(false, true);</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-4"></a>20.1.3.&#160;属性(Properties)</h3></div></div></div>
<p>
                可以通过如下方式指定数据库属性:
            </p>
<div class="itemizedlist"><ul type="disc" compact>
<li><p>通过<code class="literal">-D</code><span class="emphasis"><em>&lt;property&gt;</em></span>系统参数</p></li>
<li><p>在<code class="literal">hibernate.properties</code>文件中</p></li>
<li><p>位于一个其它名字的properties文件中,然后用 <code class="literal">--properties</code>参数指定</p></li>
</ul></div>
<p>
                所需的参数包括:
            </p>
<div class="table">
<a name="id544967"></a><p class="title"><b>表&#160;20.3.&#160;SchemaExport 连接属性</b></p>
<div class="table-contents"><table summary="SchemaExport 连接属性" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th>属性名</th>
<th>说明</th>
</tr></thead>
<tbody>
<tr>
<td><code class="literal">hibernate.connection.driver_class</code></td>
<td>jdbc driver class</td>
</tr>
<tr>
<td><code class="literal">hibernate.connection.url</code></td>
<td>jdbc url</td>
</tr>
<tr>
<td><code class="literal">hibernate.connection.username</code></td>
<td>database user</td>
</tr>
<tr>
<td><code class="literal">hibernate.connection.password</code></td>
<td>user password</td>
</tr>
<tr>
<td><code class="literal">hibernate.dialect</code></td>
<td>方言(dialect)</td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break">
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-5"></a>20.1.4.&#160;使用Ant(Using Ant)</h3></div></div></div>
<p>
                你可以在你的Ant build脚本中调用<code class="literal">SchemaExport</code>:
            </p>
<pre class="programlisting">&lt;target name="schemaexport"&gt;
    &lt;taskdef name="schemaexport"
        classname="org.hibernate.tool.hbm2ddl.SchemaExportTask"
        classpathref="class.path"/&gt;
    
    &lt;schemaexport
        properties="hibernate.properties"
        quiet="no"
        text="no"
        drop="no"
        delimiter=";"
        output="schema-export.sql"&gt;
        &lt;fileset dir="src"&gt;
            &lt;include name="**/*.hbm.xml"/&gt;
        &lt;/fileset&gt;
    &lt;/schemaexport&gt;
&lt;/target&gt;</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-6"></a>20.1.5.&#160;对schema的增量更新(Incremental schema updates)</h3></div></div></div>
<p>
                <code class="literal">SchemaUpdate</code>工具对已存在的schema采用"增量"方式进行更新。注意<code class="literal">SchemaUpdate</code>严重依赖于JDBC metadata API,所以它并非对所有JDBC驱动都有效。
            </p>
<p>
                <code class="literal">java -cp </code><span class="emphasis"><em>hibernate_classpaths</em></span>
                <code class="literal">org.hibernate.tool.hbm2ddl.SchemaUpdate</code> <span class="emphasis"><em>options mapping_files</em></span>
            </p>
<div class="table">
<a name="id545194"></a><p class="title"><b>表&#160;20.4.&#160;<code class="literal">SchemaUpdate</code>命令行选项</b></p>
<div class="table-contents"><table summary="SchemaUpdate命令行选项" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th>选项</th>
<th>说明</th>
</tr></thead>
<tbody>
<tr>
<td><code class="literal">--quiet</code></td>
<td>不要把脚本输出到stdout</td>
</tr>
<tr>
<td><code class="literal">--text</code></td>
<td>不把脚本输出到数据库</td>
</tr>
<tr>
<td><code class="literal">--naming=eg.MyNamingStrategy</code></td>
<td>选择一个命名策略 (<code class="literal">NamingStrategy</code>)</td>
</tr>
<tr>
<td><code class="literal">--properties=hibernate.properties</code></td>
<td>从指定文件读入数据库属性</td>
</tr>
<tr>
<td><code class="literal">--config=hibernate.cfg.xml</code></td>
<td>指定一个 <code class="literal">.cfg.xml</code>文件</td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break"><p>
                你可以在你的应用程序中嵌入<code class="literal">SchemaUpdate</code>工具:
            </p>
<pre class="programlisting">Configuration cfg = ....;
new SchemaUpdate(cfg).execute(false);</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-7"></a>20.1.6.&#160;用Ant来增量更新schema(Using Ant for incremental schema updates)</h3></div></div></div>
<p>
                你可以在Ant脚本中调用<code class="literal">SchemaUpdate</code>：
            </p>
<pre class="programlisting">&lt;target name="schemaupdate"&gt;
    &lt;taskdef name="schemaupdate"
        classname="org.hibernate.tool.hbm2ddl.SchemaUpdateTask"
        classpathref="class.path"/&gt;
    
    &lt;schemaupdate
        properties="hibernate.properties"
        quiet="no"&gt;
        &lt;fileset dir="src"&gt;
            &lt;include name="**/*.hbm.xml"/&gt;
        &lt;/fileset&gt;
    &lt;/schemaupdate&gt;
&lt;/target&gt;</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-8"></a>20.1.7.&#160;Schema 校验</h3></div></div></div>
<p>
                <code class="literal">SchemaValidator</code>工具会比较数据库现状是否与映射文档“匹配”。注意，<code class="literal">SchemaValidator</code> 严重依赖于JDBC的metadata API，因此不是对所有的JDBC驱动都适用。这一工具在测试的时候特别有用。
            </p>
<p>
                <code class="literal">java -cp </code><span class="emphasis"><em>hibernate_classpaths</em></span>
                <code class="literal">org.hibernate.tool.hbm2ddl.SchemaValidator</code> <span class="emphasis"><em>options mapping_files</em></span>
            </p>
<div class="table">
<a name="id545463"></a><p class="title"><b>表&#160;20.5.&#160;<code class="literal">SchemaValidator</code>命令行参数</b></p>
<div class="table-contents"><table summary="SchemaValidator命令行参数" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th>选项</th>
<th>描述</th>
</tr></thead>
<tbody>
<tr>
<td><code class="literal">--naming=eg.MyNamingStrategy</code></td>
<td>选择一个命名策略 (<code class="literal">NamingStrategy</code>)</td>
</tr>
<tr>
<td><code class="literal">--properties=hibernate.properties</code></td>
<td>从文件中读取数据库属性</td>
</tr>
<tr>
<td><code class="literal">--config=hibernate.cfg.xml</code></td>
<td>指定一个<code class="literal">.cfg.xml</code>文件</td>
</tr>
</tbody>
</table></div>
</div>
<br class="table-break"><p>
               你可以在你的应用程序中嵌入<code class="literal">SchemaValidator</code>：
            </p>
<pre class="programlisting">Configuration cfg = ....;
new SchemaValidator(cfg).validate();</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="toolsetguide-s1-9"></a>20.1.8.&#160;使用Ant进行schema校验</h3></div></div></div>
<p>
                你可以在Ant脚本中调用<code class="literal">SchemaValidator</code>:
            </p>
<pre class="programlisting">&lt;target name="schemavalidate"&gt;
    &lt;taskdef name="schemavalidator"
        classname="org.hibernate.tool.hbm2ddl.SchemaValidatorTask"
        classpathref="class.path"/&gt;
    
    &lt;schemavalidator
        properties="hibernate.properties"&gt;
        &lt;fileset dir="src"&gt;
            &lt;include name="**/*.hbm.xml"/&gt;
        &lt;/fileset&gt;
    &lt;/schemaupdate&gt;
&lt;/target&gt;</pre>
</div>
</div>
</div></body>
</html>
